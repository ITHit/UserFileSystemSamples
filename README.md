  <h1 class="d-xl-block d-none">Virtual File System Sample in .NET, C#</h1>
                <p>This sample implements a virtual file system with synchronization support, on-demand loading, selective offline files support, upload and download progress, and error reporting. It synchronizes files and folders both from remote storage to the user file system and from the user file system to remote storage. It is written in .NET Core, C#.  </p>
<p>To simulate the remote storage, this sample is using a folder in the local file system on the same machine. </p>
<p>The purpose of this sample is to demonstrate the major features of the IT Hit User File System for .NET and provide patterns for its programming. You will use this sample as a starting point for creating an OneDrive-like file system for your DMS/CRM/ERP and will reprogram it to publish data from your real storage instead of the local file system.</p>
<p>You can download this sample and a trial license in the <a href="https://www.userfilesystem.com/download/" title="IT Hit User File System for .NET Download">product download area</a>. </p>
<h2>Requirements</h2>
<ul>
<li>.NET Core 3.1 or later.</li>
<li>Microsoft Windows 10 Creators Update or later version.</li>
<li>NTFS file system.</li>
</ul>
<h2>Configuring the Sample</h2>
<p>By default, the sample will use the <span class="code">\RemoteStorage\</span> folder, located under the project root, to simulate the remote storage file structure. It will mount the user file system under the <span class="code">%USERPROFILE%\VFS\</span> folder (typically <span class="code">C:\Users\&lt;username&gt;\VFS\</span>).</p>
<p>To specify the folder that will be used for remote storage simulation edit the <span class="code">"RemoteStorageRootPath"</span> parameter in <span class="code">appsettings.json</span>. This could be either an absolute path or a path relative to the application root.</p>
<p>To specify the user file system folder edit the <span class="code">"UserFileSystemRootPath"</span> parameter in <span class="code">appsettings.json</span>.</p>
<h2>Setting the License</h2>
<p>To run the example, you will need a valid IT Hit User File System Engine for .NET License. You can download the license in the <a href="https://www.userfilesystem.com/download/" title="IT Hit User File System for .NET Download">product download area</a>. Note that the Engine is fully functional with a trial license and does not have any limitations. The trial license is valid for one month and the engine will stop working after this. You can check the expiration date inside the license file. Download the license file and specify it's content in <span class="code">License</span> field in <span class="code">appsettings.json</span> file.</p>
<p>You can also run the sample without explicitly specifying a license for 5 days. In this case, the Engine will automatically request the trial license from the IT Hit website https://www.userfilesystem.com. Make sure it is accessible via firewalls if any. After 5 days the Engine will stop working. To extend the trial period you will need to download a license in a <a href="https://www.userfilesystem.com/download/" title="IT Hit User File System for .NET Download">product download area</a> and specify it in <span class="code">appsettings.json</span></p>
<h2>Running the Sample</h2>
<p>To run the sample open the project in Visual Studio and run the project in a debug mode. In the debug mode this sample provides additional support for the development and testing convenience. When starting in the debug mode, it will automatically create a folder in which the virtual file system will reside, register the user file system with the platform and then open two instances of Windows File Manager, one of which will show a user file system and another a folder simulating remote storage:</p>
<p> <img id="__mcenew" src="https://www.userfilesystem.com/media/1985/virtualfilesysteminitialrun.png" alt="Virtual File System Sample Initial Run" rel="116795" /></p>
<p>You can start managing and editing files in the <span class="code">\RemoteStorage\</span> folder immediately after the Windows File Managers open and will see all changes being propagated to the user file system. You can also edit documents and manage file structure in the user file system and all changes will automatically appear in the remote storage folder.</p>
<p>This sample implements on-demand loading. After running the sample all files and folders are marked with a cloud icon<img id="__mcenew" src="https://www.userfilesystem.com/media/1988/offilefile.png" alt="Offline File" rel="116798" data-allowlink="false" />, which means that the content of this file or folder is not available locally but instead resides in the remote location. Even though the file shows the correct size in the Size column, the file occupies zero bytes on disk. You can open the file Properties dialog to check the "Size on disk" value. You can see in the console log that only root folder files and folders placeholders are being created when Windows File Manager listed the root folder content. Folders located deeper in the hierarchy is not loaded, until their content is being requested by platform file system calls. </p>
<p>When any application is accessing the file, located under the <span class="code">\VFS\</span> folder, opening it for reading or writing, the operating system redirects the call to this sample, which loads file content from the remote storage folder. The file becomes marked with a green check-mark on a white background icon<img id="__mcenew" src="https://www.userfilesystem.com/media/1986/localfile.png" alt="Local File" rel="116799" data-allowlink="false" />, which means the file content is present on the local disk:</p>
<p style="text-align: center;"><img id="__mcenew" src="https://www.userfilesystem.com/media/1983/localcloudfile.png" alt="Local Cloud File. Green check-mark on a white background icon means the file content is present on the local disk." rel="116801" /></p>
<p>The Windows File Manager provides the "Always keep on this device" and "Free up space" context menus, which are standard menus provided by Windows OS. If you select the "Always keep on this device" the file or entire folder structure will be recursively loaded to the local disk and all files content will be loaded to local disk and will become available offline. All files and folders are be marked with a pinned file icon<img id="__mcenew" src="https://www.userfilesystem.com/media/1989/pinnedfile.png" alt="Pinned File" rel="116800" data-allowlink="false" />. Pinned files will not be deleted from the drive even if it runs low on space.</p>
<p style="text-align: center;"><img id="__mcenew" src="https://www.userfilesystem.com/media/1982/alwayskeeponthisdevice.png" alt="Always keep on this device menu will load all files to a loacal disk and will keep them from purging on low disk space." rel="116802" /></p>
<p>To remove content from the local disk select the "Free up space" menu. It will restore the cloud icon<img id="__mcenew" src="https://www.userfilesystem.com/media/1988/offilefile.png" alt="Offline File" rel="116798" data-allowlink="false" />.</p>
<p>When a large file is being downloaded from the remote storage, this sample submits progress reports to the operation system, to show a standard Windows "Downloading" dialog. At the same time, the Windows File Manager also shows progress in the files list view:</p>
<p style="text-align: center;"><img id="__mcenew" src="https://www.userfilesystem.com/media/1984/cloudfiledownloadprogress.png" alt="Large file download from the remote storage show progress reports in Windows File Manager and Files View" rel="116804" /></p>
<h2>Microsoft Office Documents Synchronization</h2>
<p>This sample supports the synchronization of the MS Office documents, avoiding the creation of the temporary files in remote storage. Note that for the sake of simplicity this sample filters MS Office temporary files only during user file system to remote storage synchronization. It is expected that MS Office temporary files are not created in remote storage and you do not need to synchronize them from server to client. Do NOT edit MS Office files directly in the folder simulating the remote storage.</p>
<h2>Stopping the Sample</h2>
<p>You can exit the sample running in the debug mode in 2 ways:</p>
<ul>
<li>If you press 'q' the user file system will be unregistered. All files and folders downloaded on disk will be converted into the regular files and folders. The offline files and folders will disappear. This simulates your application's uninstallation process.</li>
<li>If you press any other key, the application will exit without unregistering the user file system. All files and folders placeholders, their attributes, and states remain in the user file system, even though most of the functionality, such as downloading file content or listing folder content for offline folders are unavailable. You can start this sample again to continue managing documents. This simulates the machine reboot or application failure.</li>
</ul>
<h2>How the Sample Works</h2>
<h3>On-Demand Loading</h3>
<p>Initially, when you start the application, the user file system does not contain any file of folder placeholders, except the sync root folder. The content of the folders is populated only when any application is listing folder content. The content of files is loaded only when an application is opening a file for reading or writing.</p>
<h3>Platform File System Operations Handling</h3>
<p>Folder content listing, file reads, move/rename and delete is performed by the <span class="code">VfsEngine</span> and <span class="code">VfsFile</span> and <span class="code">VfsFolder</span> classes.  </p>
<p>The initial folder content listing is done inside <span class="code">VfsFolder</span>.<span class="code">GetChildrenAsync()</span> method call. When any application is listing folder content, the <span class="code">VfsEngine</span> class creates the <span class="code">VfsFolder</span> class instance that corresponds to the requested folder. Then the Engine calls <span class="code">GetChildrenAsync()</span> method.</p>
<p>As soon as the folder content is populated with placeholders during the first access, the <span class="code">GetChildrenAsync()</span> is never called again for this particular folder. Instead, to update the folder content, this sample monitors changes in the remote storage and applies them to the user file system. See the "Remote Storage to User File System Synchronization" section below.</p>
<h3>Hydration/Dehydration via Windows File Manager Commands</h3>
<p>When the user selects "Always keep on this device" or the "Free up space" in the Windows file manager, the file is marked with a Pinned or Unpinned attribute respectively. The hydration/dehydration itself is performed later when the <span class="code">UserFileSystemMonitor</span> class detects attribute changes in the user file system or during the synchronization process by the SyncService class. </p>
<h3>Remote Storage to User File System Synchronization</h3>
<p>The remote storage is simulated by the dedicated folder in the file system (<span class="code">\RemoteStorage\</span> by default). The sample monitors changes in it using <span class="code">RemoteStorageMonitor</span> class that generates events and applies corresponding changes in the user file system. The <span class="code">RemoteStorageMonitor</span> class is using <span class="code">FileSystemWatcher</span> which can monitor the creation, update of file content and attributes, deletion, and rename. The <span class="code">FileSystemWatcher</span> class can NOT monitor the move event. In your real-life application, you will replace the <span class="code">FileSystemWatcher</span> with web sockets or any other technology that will send events from your server to all connected clients.</p>
<h3>User File System to Remote Storage Synchronization</h3>
<p>The user file system to remote storage synchronization is performed by <span class="code">VfsFile</span>, <span class="code">VfsFileSystemItem</span>, and <span class="code">UserFileSystemMonitor</span> classes:</p>
<p><span class="code"> VfsFile</span>.<span class="code">Close()</span> - This method is called by the Engine when the application releases the file handle. The code in this method uploads the file to the remote storage when the file is closed by the application. Note that when this method is called, the file may be still blocked by other processes, so upload may often fail, which is normal behavior. The file will be uploaded during the last <span class="code">Close()</span> method call or during the synchronization process.</p>
<p><span class="code">VfsFileSystemItem</span>.<span class="code">MoveToAsync()</span> and <span class="code">VfsFileSystemItem</span>.<span class="code">DeleteAsync()</span> - In this methods files and folders are moved and deleted in the remote storage.</p>
<p><span class="code">UserFileSystemMonitor</span>.CreatedAsync() - In this method, new files and folders are created. Note that files and folders are created as regular files/folders, in this method they are converted into placeholders.</p>
<h3>Full File System Synchronization</h3>
<p>The complete synchronization is performed in the <span class="code">SyncService</span> class. Due to the nature of this sample, this class goes folder-by-folder to synchronize the entire file system. This class first processes moved/renamed files and folders and then creates, deletes, and updates files and folders.</p>
<p>Because of the simplicity of this sample, the files deleted in the user file system, then this Virtual File System sample application was not running, or during network or server outage, are not synched to remote storage (they are normally deleted inside <span class="code">VfsFileSystemItem</span>.<span class="code">DeleteAsync()</span> call). Instead, the file will be restored in the user file system when the synchronization service runs.</p>
<p>You can adapt the <span class="code">SyncService</span> class implementation to your needs depending on your remote storage type.</p>
<h2>In-Sync Status and ETag Usage For Synchronization</h2>
<p>Synchronization in this Virtual File System sample is based on In-Sync file status as well as on ETag received from the server.</p>
<p>During remote storage to user file system synchronization, each file/folder receives an ETag from the server and stores it in custom data associated with the file/folder in the user file system. The remote storage to user file system synchronization is performed only if the file on the client is marked as In-Sync (<img id="__mcenew" src="https://www.userfilesystem.com/media/1986/localfile.png" alt="In-Sync icon" rel="118449" /> or <img id="__mcenew" src="https://www.userfilesystem.com/media/1989/pinnedfile.png" alt="Pinned file" rel="118452" /> or <img id="__mcenew" src="https://www.userfilesystem.com/media/1988/offilefile.png" alt="Cloud file" rel="118451" />) with the server. If the file is modified on the server and is marked as not In-Sync on the client, the files are considered to be in conflict, the conflict icon is displayed.</p>
<p>When any file or folder in the user file system is updated it is marked as not In-Sync<img id="__mcenew" src="https://www.userfilesystem.com/media/1987/notinsyncfile.png" alt="Not in sync icon" rel="118450" />, which means the content must be sent to the server. During the user file system to remote storage synchronization, the ETag stored with the file on the client is compared with the ETag in the remote storage, to avoid the server changes to be overwritten. The file/folder is updated only if the ETags match. Otherwise, the file/folder is considered to be in conflict and marked with the conflict icon.</p>
<p>Because of the nature of the remote storage simulation, this sample is using file/folder last modification date/time as an ETag. Instead, in your real-life storage, you will update ETag during each file modification in your storage and will NOT use the file/folder modification date.</p>