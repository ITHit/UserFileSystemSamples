
<h1 class="d-xl-block d-none">Virtual File System Sample in .NET, C#</h1>
<p>This sample implements a virtual file system with synchronization support, on-demand loading,&nbsp;selective offline files support, upload and download progress, and error reporting. It synchronizes files and folders both from remote storage to the user file system and from the user file system to remote storage. It is written in .NET Core, C#.&nbsp;&nbsp;</p>
<p>To simulate the remote storage, this sample is using a folder in the local file system on the same machine.&nbsp;</p>
<p>The purpose of this sample is to demonstrate the major features of the IT Hit User File System for .NET and provide patterns for its programming. You will use this sample as a starting point for creating a OneDrive-like file system for your DMS/CRM/ERP and will reprogram it to publish data from your real storage instead of the local file system.&nbsp;This sample provides a bare minimum code and functionality for demo purposes for an advanced sample with Microsoft Office editing support, automatic locking support and custom properties support see the <a title="Virtual Drive Sample in .NET, C#" href="https://www.userfilesystem.com/examples/virtual_drive/">Virtual Drive sample</a>.</p>
<p>You can download this sample and a trial license in the&nbsp;<a title="IT Hit User File System for .NET Download" href="https://www.userfilesystem.com/download/">product download area</a>. You can also clone it and browse the code on&nbsp;<a title="Virtual File System Sample in .NET, C#" href="https://github.com/ITHit/UserFileSystemSamples/tree/master/Windows/VirtualFileSystem">GitHub</a>.&nbsp;</p>
<h2>Requirements</h2>
<ul>
<li>.NET 3.1 or later.</li>
<li>Microsoft Windows 10 Creators Update or later version.</li>
<li>NTFS file system.</li>
</ul>
<h2>Configuring the Sample</h2>
<p>By default, the sample will use the <span class="code">\RemoteStorage\</span> folder, located under the project root, to simulate the remote storage file structure. It will mount the user file system under the <span class="code">%USERPROFILE%\VFS\</span> folder (typically&nbsp;<span class="code">C:\Users\&lt;username&gt;\VFS\</span>).</p>
<p>To specify the folder that will be used for remote storage simulation edit the&nbsp;<span class="code">"RemoteStorageRootPath"</span> parameter in <span class="code">appsettings.json</span>. This could be either an absolute path or a path relative to the application root.</p>
<p>To specify the user file system folder edit the&nbsp;<span class="code">"UserFileSystemRootPath"</span> parameter&nbsp;in <span class="code">appsettings.json</span>.</p>
<h2>Setting the License</h2>
<p>To run the example, you will need a valid IT Hit User File System Engine for .NET License. You can download the license in&nbsp;the&nbsp;<a title="IT Hit User File System for .NET Download" href="https://www.userfilesystem.com/download/">product download area</a>.&nbsp;Note that the Engine is fully functional with a trial license and does not have any limitations. The trial license is valid for one month and the engine will stop working after this. You can check the expiration date inside the license file.&nbsp;Download the license file and specify it's content in&nbsp;<span class="code">License</span>&nbsp;field in&nbsp;<span class="code">appsettings.json</span>&nbsp;file.</p>
<p>You can also run the sample&nbsp;without explicitly specifying a license&nbsp;for 5 days. In this case,&nbsp;the&nbsp;Engine will automatically request the trial license from the IT Hit website https://www.userfilesystem.com. Make sure it is accessible via firewalls if any. After 5 days the Engine will stop working. To extend the trial period you will need to download a license in a&nbsp;<a title="IT Hit User File System for .NET Download" href="https://www.userfilesystem.com/download/">product download area</a>&nbsp;and specify it in&nbsp;<span class="code">appsettings.json</span></p>
<h2>Running the Sample</h2>
<p>To run the sample open the project in Visual Studio and run the project in a debug mode.&nbsp;In the debug mode this sample provides additional support for the development and testing convenience. When starting in the debug mode, it will automatically create a folder in which the virtual file system will reside, register the user file system with the platform and then open&nbsp;two instances of Windows File Manager, one of which will show a user file system and another a folder simulating remote storage:</p>
<p>&nbsp;<img id="__mcenew" alt="Virtual File System Sample Initial Run" src="https://www.userfilesystem.com/media/1985/virtualfilesysteminitialrun.png" rel="116795"></p>
<p>You can start managing and editing files in the <span class="code">\RemoteStorage\</span> folder immediately after the Windows File Managers open and will see all changes being propagated to the user file system. You can also edit documents and manage file structure in the user file system and all changes will automatically appear in the remote storage folder. Note that this sample does NOT support Microsoft Office document editing, for the Microsoft Office document editing&nbsp;and other advanced features see the <a title="Virtual Drive Sample in .NET, C#" href="https://www.userfilesystem.com/examples/virtual_drive/">Virtual Drive sample</a>.</p>
<p>This sample implements on-demand loading. After running the sample all files and folders are marked with a cloud icon&nbsp;<img id="__mcenew" alt="Offline File" src="https://www.userfilesystem.com/media/1988/offilefile.png" rel="116798" data-allowlink="false">, which means that the content of this file or folder is not available locally but instead resides in the remote location. Even though the file shows the correct size in the Size column, the file occupies zero bytes on the disk. You can open the file Properties dialog to check the "Size on disk" value. You can see in the console log that only root folder files and folder placeholders are being created when Windows File Manager listed the root folder content. Folders located deeper in the hierarchy are not loaded until their content is being requested by the platform file system calls.&nbsp;</p>
<p>When any application is accessing the file, located under the <span class="code">\VFS\</span> folder, opening it for reading or writing, the operating system redirects the call to this sample, which loads file content from the remote storage folder. The file becomes marked with a green check-mark on a white background icon<img id="__mcenew" alt="Local File" src="https://www.userfilesystem.com/media/1986/localfile.png" rel="116799" data-allowlink="false">, which means the file content is present on the local disk:</p>
<p style="text-align: center;"><img id="__mcenew" alt="Local Cloud File. Green check-mark on a white background icon means the file content is present on the local disk." src="https://www.userfilesystem.com/media/1983/localcloudfile.png" rel="116801"></p>
<p>The Windows File Manager provides the "Always keep on this device" and "Free up space" context menus, which are standard menus provided by Windows OS. If you select the&nbsp;"Always keep on this device" the file or entire folder structure will be recursively loaded to the local disk and files content will be loaded to the local disk and will become available offline. All files and folders are marked with a pinned file icon<img id="__mcenew" alt="Pinned File" src="https://www.userfilesystem.com/media/1989/pinnedfile.png" rel="116800" data-allowlink="false">. Pinned files will not be deleted from the drive even if it runs low on space.</p>
<p style="text-align: center;"><img id="__mcenew" alt="Always keep on this device menu will load all files to a loacal disk and will keep them from purging on low disk space." src="https://www.userfilesystem.com/media/1982/alwayskeeponthisdevice.png" rel="116802"></p>
<p>To remove content from the local disk select the "Free up space" menu. It will restore the cloud icon&nbsp;<img id="__mcenew" alt="Offline File" src="https://www.userfilesystem.com/media/1988/offilefile.png" rel="116798" data-allowlink="false">.</p>
<p>When a large file is being downloaded from the remote storage, this sample submits progress reports to the operation system, to show a standard Windows "Downloading" dialog. At the same time, the Windows File Manager also shows progress in the files list view:</p>
<p style="text-align: center;"><img id="__mcenew" alt="Large file download from the remote storage show progress reports in Windows File Manager and Files View" src="https://www.userfilesystem.com/media/1984/cloudfiledownloadprogress.png" rel="116804"></p>
<h2>Stopping the Sample</h2>
<p>You can exit the sample running in the debug mode in 3 ways:</p>
<ul>
<li>If you press 'Q' the user file system will be unregistered and all files will be deleted. This simulates uninstall with complete cleanup.&nbsp;</li>
<li>If you press 'q' the user file system will be unregistered. All files and folders downloaded on disk will be converted into regular files and folders. The offline files and folders will disappear. This simulates your application's uninstallation process.</li>
<li>If you press any other key, the application will exit without unregistering the user file system. All files and folders placeholders, their attributes, and states remain in the user file system, even though most of the functionality, such as downloading file content or listing folder content for offline folders are unavailable. You can start this sample again to continue managing documents. This simulates the machine reboot or application failure.</li>
</ul>
<h2>How the Sample Works</h2>
<h3>On-Demand Loading</h3>
<p>Initially, when you start the application, the user file system does not contain any file of folder placeholders, except the sync root folder. The content of the folders is populated only when any application is listing folder content. The content of files is loaded only when an application is opening a file for reading or writing.</p>
<h3>Platform File System Operations Handling</h3>
<p>Folder content listing, file reads, move/rename and delete are performed by the <span class="code">VirtualEngine</span>&nbsp;,&nbsp;<span class="code">VirtualFile</span> and <span class="code">VirtuaFolder</span> classes.&nbsp;&nbsp;</p>
<p>The initial folder content listing is done inside <span class="code">VirtualFolder</span>.<span class="code">GetChildrenAsync()</span> method call. When any application is listing folder content, the <span class="code">VirtualEngine</span> class creates the <span class="code">VirtualFolder</span> class instance that corresponds to the requested folder inside the <span class="code">VirtualEngine</span>.<span class="code">GetFileSystemItemAsync()</span> factory method. Then the <span class="code">VirtualEngine</span>&nbsp;class calls&nbsp;<span class="code">GetChildrenAsync()</span> method on the returned folder item.</p>
<p>As soon as the folder content is populated with placeholders during the first access, the&nbsp;<span class="code">GetChildrenAsync()</span> is never called again for this particular folder. Instead, to update the folder content, this sample monitors changes in the remote storage and applies them to the user file system. See the "Remote Storage to User File System Synchronization" section below.</p>
<h3>Hydration/Dehydration via Windows File Manager Commands</h3>
<p>When the user selects "Always keep on this device" or the "Free up space" in the Windows file manager, the file is marked with a Pinned or Unpinned attribute respectively. The Engine detects these flags triggering hydration or dehydration if needed. To hydrate the file the <span class="code">VirtualFile</span>.<span class="code">ReadAsync()</span> method is called.</p>
<h3>Remote Storage to User File System Synchronization</h3>
<p>The remote storage is simulated by the dedicated folder in the file system (<span class="code">\RemoteStorage\</span> by default). The sample monitors changes in it using&nbsp;<span class="code">RemoteStorageMonitor</span> class that generates events and applies corresponding changes in the user file system. The&nbsp;<span class="code">RemoteStorageMonitor</span> class is using a&nbsp;<span class="code">FileSystemWatcherQueued</span> class which is similar to&nbsp;<span class="code">FileSystemWatcher</span> which can monitor the creation, update of file content and attributes, deletion, and rename. But unlike the&nbsp;<span>FileSystemWatcher, the&nbsp;<span>FileSystemWatcherQueued class can process a large number of events</span></span>&nbsp;and is tested on the highly loaded file system. Note that the&nbsp;<span class="code">FileSystemWatcherQueued</span>&nbsp;class (as well as <span class="code">FileSystemWatcher</span>&nbsp;class) can NOT monitor the move event. In your real-life application, you will replace the&nbsp;<span class="code">FileSystemWatcherQueued</span>&nbsp;class with web sockets or any other technology that will send events from your server to all connected clients.</p>
<h3>User File System to Remote Storage Synchronization</h3>
<p>The user file system to remote storage synchronization is performed by <span class="code">VirtualFile</span>&nbsp;and <span class="code">VirtualFolder</span> classes. When a file or folder is created in the file system, the <span class="code">VirtualFolder</span>.<span class="code">CreateFileAsync()</span> and <span class="code">VirtualFolder</span>.<span class="code">CreateFolderAsync()</span>&nbsp;methods are called. When the file content is modified on the client the <span class="code">VirtualFile</span>.<span class="code">WriteAsync()</span> method is called. When a file or folder is moved or deleted the&nbsp;<span class="code">VfsFileSystemItem</span>.<span class="code">MoveToAsync()</span>&nbsp;and&nbsp;<span class="code">VfsFileSystemItem</span>.<span class="code">DeleteAsync()</span> methods are called.</p>
<h3 class="para d-inline next-article-heading">Next Article:</h3>
<a title="Virtual File System Sample for Mac in .NET, C#" href="https://www.userfilesystem.com/examples/virtual_file_system_mac/">Virtual File System Sample for Mac in .NET, C#</a>

